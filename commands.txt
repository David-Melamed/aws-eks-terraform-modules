commands:
#Connect Cluster
kubectl config get-contexts
aws eks update-kubeconfig --name ekslab --role-arn arn:aws:iam::<ACCOUNT_ID>:role/<CLUSTER_ROLE_NAME>
kubectl config get-contexts
kubectl config use-context arn:aws:eks:<REGION>:<ACCOUNT_ID>:cluster/<cluster_name>

#Install Argo:
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.4.7/manifests/install.yaml
kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'
kubectl port-forward svc/argocd-server -n argocd 8080:443
export ARGOCD_SERVER=`kubectl get svc argocd-server -n argocd -o json | jq --raw-output '.status.loadBalancer.ingress[0].hostname'`
export ARGO_PWD=`kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d`
argocd login $ARGOCD_SERVER --username admin --password $ARGO_PWD --insecure


##Create IAM Role using eksctl
eksctl create iamserviceaccount --cluster=ekslab --namespace=kube-system --name=aws-load-balancer-controller --attach-policy-arn=arn:aws:iam::<ACCOUNT_ID>:policy/AWSLoadBalancerControllerIAMPolicy --role-name AmazonEKSLoadBalancerControllerRole --approve


## Instal aws-load-balancer-controller
helm install aws-load-balancer-controller eks/aws-load-balancer-controller --set clusterName=ekslab --set serviceAccount.create=false --set region=eu-west-1 --set vpcId=vpc-0034e4aeb0deaa837 --set serviceAccount.name=aws-load-balancer-controller -n kube-system


##Verification
kubectl get deployment -n kube-system aws-load-balancer-controller


#Rollback
#Delete IAM serviceAccount
eksctl delete iamserviceaccount --cluster=ekslab --name=aws-load-balancer-controller --namespace=kube-system

## Delete aws-load-balancer-controller
helm delete aws-load-balancer-controller -n kube-system

#Get token
aws eks get-token --cluster-name ekslab --role-arn arn:aws:iam::<ACCOUNT_ID>:role/<CLUSTER_ROLE_NAME>

#Edit cluster auth configmap to allow RBAC permissions (replace content of auth.yaml)
kubectl edit configmap aws-auth -n kube-system

#Associate OIDC permission to EKS cluster
eksctl utils associate-iam-oidc-provider \
    --region eu-west-1 \
    --cluster ekslab \
    --approve
